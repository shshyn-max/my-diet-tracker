<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ë™ê¸°í™” ë‹¤ì´ì–´íŠ¸ íŠ¸ë˜ì»¤</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        /* 2. ì•„ì´í° í„°ì¹˜ í•˜ì´ë¼ì´íŠ¸ ë° ê¸°ë³¸ í°íŠ¸ ìµœì í™” */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", sans-serif; 
            background-color: #f0f2f5; padding: 10px; margin: 0; color: #333;
            -webkit-tap-highlight-color: transparent; 
        }
        .container { 
            background: white; padding: 20px 15px; border-radius: 16px; 
            box-shadow: 0 8px 30px rgba(0,0,0,0.08); 
            overflow-x: auto; 
            -webkit-overflow-scrolling: touch; /* ì•„ì´í°ì—ì„œ ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ */
        }
        .header-area { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; min-width: 1000px; }
        .left-controls { display: flex; align-items: center; gap: 15px; }
        select { padding: 8px; border-radius: 8px; border: 1px solid #ddd; font-size: 16px; font-weight: bold; background: #fff; }
        .btn-add { background: #007aff; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; }
        
        /* 3. í…Œì´ë¸” êµ¬ì¡° ë° ê³ ì • ì—´(Sticky) ìµœì í™” */
        table { border-collapse: collapse; width: 100%; min-width: 1250px; table-layout: fixed; }
        th, td { padding: 10px 0; border-bottom: 1px solid #f1f3f5; text-align: center; }
        .checklist-item { 
            text-align: left; width: 180px !important; background: #fff; 
            position: sticky; left: 0; z-index: 20; 
            display: flex; align-items: center; padding-left: 5px;
            border-right: 1px solid #f0f0f0;
        }
        /* ì•„ì´í° ì¸í’‹ í°íŠ¸ í¬ê¸° 16px ë¯¸ë§Œì¼ ì‹œ ìë™ ì¤Œ ë°œìƒ ì°¨ë‹¨ */
        .checklist-item input { border: 1px solid transparent; font-size: 16px; padding: 5px; width: 85%; outline: none; background: transparent; }
        .btn-del { color: #ff3b30; border: none; background: none; cursor: pointer; font-size: 18px; margin-right: 3px; }

        .date-th { font-size: 11px; color: #8e8e93; width: 34px; }
        
        /* 4. ë™ê·¸ë¼ë¯¸ í„°ì¹˜ ì˜ì—­ í™•ëŒ€ (UX ê°œì„ ) */
        .status-cell { width: 34px; height: 40px; vertical-align: middle; }
        .circle { 
            width: 24px; height: 24px; border-radius: 50%; border: 2px solid #d1d1d6; 
            margin: 0 auto; cursor: pointer; transition: transform 0.1s;
        }
        .circle.none { background-color: #fff; }
        .circle.good { background-color: #34c759; border-color: #34c759; }
        .circle.normal { background-color: #007aff; border-color: #007aff; }
        .circle.bad { background-color: #ff3b30; border-color: #ff3b30; }

        .legend { display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; font-size: 13px; }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-area">
        <div class="left-controls">
            <h2 style="font-size: 18px; margin:0;">ğŸ—“ ë‹¤ì´ì–´íŠ¸ íŠ¸ë˜ì»¤</h2>
            <select id="monthSelect" onchange="changeMonth()"></select>
        </div>
        <button class="btn-add" onclick="addRow()">+ ì¶”ê°€</button>
    </div>
    
    <div class="legend">
        <div class="legend-item"><div class="dot" style="background:#34c759"></div>ì˜í•¨</div>
        <div class="legend-item"><div class="dot" style="background:#007aff"></div>ë³´í†µ</div>
        <div class="legend-item"><div class="dot" style="background:#ff3b30"></div>ëª»í•¨</div>
    </div>

    <table>
        <thead><tr id="dateHeader"><th style="width: 180px; text-align: left; padding-left: 10px; background:#f8f9fa;">ìŠµê´€ í•­ëª©</th></tr></thead>
        <tbody id="trackerBody"></tbody>
    </table>
</div>

<script>
    // ìƒí¬ ë‹˜ì˜ Firebase ì„¤ì • ìœ ì§€
    const firebaseConfig = {
        apiKey: "AIzaSyDzsgX2NvbQLlYRu8eZr7BngxcTzaXD3Mw",
        authDomain: "ymy-diet-sync.firebaseapp.com",
        projectId: "my-diet-sync",
        storageBucket: "my-diet-sync.firebasestorage.app",
        messagingSenderId: "1021774151274",
        appId: "1:1021774151274:web:f03efd0240a3899a8d1413"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    // 5. ì˜¤í”„ë¼ì¸ ì§€ì†ì„± í™œì„±í™” (ì•„ì´í° ë™ê¸°í™” ì•ˆì •ì„± ê°•í™”)
    firebase.firestore().enablePersistence().catch((err) => {
        console.warn("Persistence failed", err.code);
    });

    const DAYS = 31;
    let currentMonth = String(new Date().getMonth() + 1);
    let allMonthsData = {};

    function syncData() {
        db.collection("diet_tracker").doc("sanghee").onSnapshot((doc) => {
            if (doc.exists()) {
                allMonthsData = doc.data();
                render();
            } else {
                allMonthsData[currentMonth] = { items: [{ name: "ë¬¼ 2L ë§ˆì‹œê¸°", history: Array(31).fill('none') }] };
                saveToDB();
            }
        }, (error) => {
            console.error("Firebase sync error:", error);
        });
    }

    function saveToDB() {
        db.collection("diet_tracker").doc("sanghee").set(allMonthsData);
    }

    function changeMonth() {
        currentMonth = document.getElementById('monthSelect').value;
        if (!allMonthsData[currentMonth]) {
            allMonthsData[currentMonth] = { items: [{ name: "ìƒˆ ì›” í•­ëª©", history: Array(31).fill('none') }] };
            saveToDB();
        }
        render();
    }

    function render() {
        const dateHeader = document.getElementById('dateHeader');
        const trackerBody = document.getElementById('trackerBody');
        
        while (dateHeader.children.length > 1) dateHeader.removeChild(dateHeader.lastChild);
        for (let i = 1; i <= DAYS; i++) {
            const th = document.createElement('th');
            th.className = 'date-th'; th.innerText = i;
            dateHeader.appendChild(th);
        }

        trackerBody.innerHTML = '';
        const monthData = allMonthsData[currentMonth] || { items: [] };

        monthData.items.forEach((item, rIndex) => {
            const tr = document.createElement('tr');
            const nameTd = document.createElement('td');
            nameTd.className = 'checklist-item';
            
            const delBtn = document.createElement('button');
            delBtn.className = 'btn-del'; delBtn.innerHTML = 'âŠ–';
            delBtn.onclick = () => {
                if(confirm('ì‚­ì œí• ê¹Œìš”?')) {
                    monthData.items.splice(rIndex, 1);
                    saveToDB();
                }
            };
            
            const input = document.createElement('input');
            input.value = item.name;
            input.onchange = (e) => {
                item.name = e.target.value;
                saveToDB();
            };

            nameTd.appendChild(delBtn);
            nameTd.appendChild(input);
            tr.appendChild(nameTd);

            for (let d = 0; d < DAYS; d++) {
                const td = document.createElement('td');
                td.className = 'status-cell';
                const circle = document.createElement('div');
                circle.className = `circle ${item.history[d]}`;
                // 6. í„°ì¹˜ ë°˜ì‘ì„± ê°œì„ : ë‚™ê´€ì  ì—…ë°ì´íŠ¸ ì ìš©
                circle.onclick = (e) => {
                    e.preventDefault();
                    const states = ['none', 'good', 'normal', 'bad'];
                    const next = states[(states.indexOf(item.history[d]) + 1) % 4];
                    item.history[d] = next;
                    circle.className = `circle ${next}`; // ì¦‰ì‹œ ë°˜ì˜
                    saveToDB();
                };
                td.appendChild(circle);
                tr.appendChild(td);
            }
            trackerBody.appendChild(tr);
        });
    }

    function addRow() {
        if (!allMonthsData[currentMonth]) allMonthsData[currentMonth] = { items: [] };
        allMonthsData[currentMonth].items.push({ name: "ìƒˆ í•­ëª©", history: Array(31).fill('none') });
        saveToDB();
    }

    function init() {
        const select = document.getElementById('monthSelect');
        for (let i = 1; i <= 12; i++) {
            const opt = document.createElement('option');
            opt.value = String(i); opt.innerText = i + 'ì›”';
            if (i === parseInt(currentMonth)) opt.selected = true;
            select.appendChild(opt);
        }
        syncData();
    }

    init();
</script>
</body>
</html>