<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ë‹¤ì´ì–´íŠ¸ íŠ¸ë˜ì»¤</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", sans-serif; 
            background-color: #f0f2f5; margin: 0; padding: 0;
            -webkit-tap-highlight-color: transparent; 
        }

        /* 1. ìƒë‹¨ í—¤ë” ê³ ì •: ìŠ¤í¬ë¡¤í•´ë„ í•­ìƒ ë³´ì„ */
        .sticky-header {
            position: sticky; top: 0; z-index: 100;
            background: #fff; padding: 15px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .container { padding: 10px; overflow-x: auto; -webkit-overflow-scrolling: touch; }

        .btn-add { background: #007aff; color: white; border: none; padding: 8px 16px; border-radius: 8px; font-weight: 600; font-size: 14px; }
        
        table { border-collapse: collapse; min-width: 1200px; table-layout: fixed; }
        
        /* 2. ì²« ë²ˆì§¸ ì—´(í•­ëª© ì´ë¦„) ì™¼ìª½ ê³ ì • */
        .checklist-item { 
            position: sticky; left: 0; z-index: 50; 
            background: #fff !important; 
            width: 200px !important; 
            min-width: 200px; /* ë„ˆë¹„ ê³ ì • */
            text-align: left; padding: 0 10px;
            border-right: 2px solid #f0f2f5;
            white-space: nowrap;
            display: table-cell; /* í…Œì´ë¸” ì†ì„± ìœ ì§€ */
            vertical-align: middle;
        }

        /* 3. ëª¨ë°”ì¼ ê°€ë…ì„±ì„ ìœ„í•œ ë‚ ì§œ ë° ì…€ í¬ê¸° ì¡°ì • */
        .date-th { font-size: 11px; color: #8e8e93; width: 32px; background: #f8f9fa; }
        .status-cell { width: 32px; height: 45px; }
        
        .circle { 
            width: 24px; height: 24px; border-radius: 50%; border: 2px solid #d1d1d6; 
            margin: 0 auto; transition: transform 0.1s;
        }
        .circle.good { background-color: #34c759; border-color: #34c759; }
        .circle.normal { background-color: #007aff; border-color: #007aff; }
        .circle.bad { background-color: #ff3b30; border-color: #ff3b30; }

        .legend { display: flex; justify-content: center; gap: 15px; padding: 15px; font-size: 12px; background: #fff; margin-top: 10px; }
        /* ìƒˆë¡œ ì¶”ê°€: ì…ë ¥ì°½ê³¼ ë²„íŠ¼ì„ ê°€ë¡œë¡œ ì •ë ¬í•´ì¤„ ë„ìš°ë¯¸ */
        .item-wrapper {
            display: flex;
            align-items: center;
            width: 100%;
        }

        input { 
            flex: 1; min-width: 0; /* ê¸€ìê°€ ê¸¸ì–´ì ¸ë„ ë°€ë¦¬ì§€ ì•Šê²Œ í•¨ */
            font-size: 16px !important; border: none; background: transparent; outline: none; 
            -webkit-appearance: none; /* ì•„ì´í° ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì œê±° */
            /* ... ê¸°ì¡´ ì½”ë“œ ... */
            outline: none; 
            box-shadow: none;
        }

        /* --- ì—¬ê¸°ì„œë¶€í„° ì•„ë˜ ë‚´ìš©ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš” --- */
        @media (prefers-color-scheme: dark) {
            body { background-color: #1c1c1e; color: #f2f2f7; }
            .sticky-header { background: #2c2c2e; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
            .sticky-header h2 { color: #ffffff; }
            .container { background: #1c1c1e; }
            .checklist-item { background: #2c2c2e !important; border-right: 2px solid #3a3a3c; }
            .checklist-item input { color: #ffffff; }
            th.date-th { background-color: #3a3a3c; color: #aeaeb2; }
            td { border-bottom: 1px solid #3a3a3c; }
            .legend { background: #2c2c2e; color: #f2f2f7; }
            select { background: #3a3a3c; color: #ffffff; border: 1px solid #48484a; }
            .circle.none { background-color: #2c2c2e; border-color: #48484a; }
        }
        /* --- ì—¬ê¸°ê¹Œì§€ --- */
    </style>
</head>
<body>

<div class="sticky-header">
    <div style="display:flex; align-items:center; gap:10px;">
        <h2 style="font-size: 18px; margin:0;">ğŸ—“ ìƒí¬ ë‹¤ì´ì–´íŠ¸ ê¸°ë¡</h2>
        <select id="monthSelect" onchange="changeMonth()" style="font-size:16px; font-weight:bold; border-radius:5px; border:1px solid #ddd; padding:4px;"></select>
    </div>
    <button class="btn-add" onclick="addRow()">+ ì¶”ê°€</button>
</div>

<div class="container">
    <table>
        <thead><tr id="dateHeader"><th class="checklist-item">ìŠµê´€ í•­ëª©</th></tr></thead>
        <tbody id="trackerBody"></tbody>
    </table>
</div>

<div class="legend">
    <div style="display:flex; align-items:center; gap:4px;"><span style="width:10px; height:10px; border-radius:50%; background:#34c759"></span>ì˜í•¨</div>
    <div style="display:flex; align-items:center; gap:4px;"><span style="width:10px; height:10px; border-radius:50%; background:#007aff"></span>ë³´í†µ</div>
    <div style="display:flex; align-items:center; gap:4px;"><span style="width:10px; height:10px; border-radius:50%; background:#ff3b30"></span>ëª»í•¨</div>
</div>

<script>
    // ìƒí¬ ë‹˜ì˜ ê¸°ì¡´ Firebase ì„¤ì •ê°’ì„ ìœ ì§€í•˜ì„¸ìš”.
    const firebaseConfig = {
        apiKey: "AIzaSyDzsgX2NvbQLlYRu8eZr7BngxcTzaXD3Mw",
        authDomain: "ymy-diet-sync.firebaseapp.com",
        projectId: "my-diet-sync",
        storageBucket: "my-diet-sync.firebasestorage.app",
        messagingSenderId: "1021774151274",
        appId: "1:1021774151274:web:f03efd0240a3899a8d1413"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const DAYS = 31;
    let currentMonth = String(new Date().getMonth() + 1);
    let allMonthsData = {};

function syncData() {
        db.collection("diet_tracker").doc("sanghee").onSnapshot((doc) => {
            if (doc.exists) {
                const data = doc.data();
                // ì„œë²„ì˜ ì „ì²´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ë˜, í˜„ì¬ ë‹¬ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´ë¡œ ì´ˆê¸°í™”
                allMonthsData = data;
                
                // ìˆ«ìë¡œ ëœ í•„ë“œ(2)ì™€ ë¬¸ìì—´("2") ëª¨ë‘ ëŒ€ì‘í•˜ê¸° ìœ„í•´ í˜„ì¬ ë‹¬ ë°ì´í„° í™•ì¸
                if (!allMonthsData[currentMonth]) {
                    allMonthsData[currentMonth] = { items: [] };
                }
                render();
            } else {
                // ì„œë²„ì— ë°ì´í„°ê°€ ì•„ì˜ˆ ì—†ëŠ” ê²½ìš°ë§Œ ì´ˆê¸° ë°ì´í„° ìƒì„±
                allMonthsData[currentMonth] = { items: [{ name: "ë¬¼ 2L ë§ˆì‹œê¸°", history: Array(31).fill('none') }] };
                saveToDB();
            }
        }, (error) => {
            console.error("ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì—ëŸ¬:", error);
        });
    }

    function saveToDB() {
        db.collection("diet_tracker").doc("sanghee").set(allMonthsData);
    }

    function changeMonth() {
        currentMonth = document.getElementById('monthSelect').value;
        if (!allMonthsData[currentMonth]) {
            allMonthsData[currentMonth] = { items: [{ name: "ìƒˆ ì›” í•­ëª©", history: Array(31).fill('none') }] };
            saveToDB();
        }
        render();
    }

    function render() {
        const dateHeader = document.getElementById('dateHeader');
        const trackerBody = document.getElementById('trackerBody');
        
        while (dateHeader.children.length > 1) dateHeader.removeChild(dateHeader.lastChild);
        const todayDate = new Date().getDate(); // ì˜¤ëŠ˜ì´ ëª‡ ì¼ì¸ì§€ ê°€ì ¸ì˜µë‹ˆë‹¤.

for (let i = 1; i <= DAYS; i++) {
    const th = document.createElement('th');
    th.className = 'date-th';
    th.innerText = i;
    
    // ë§Œì•½ iê°€ ì˜¤ëŠ˜ ë‚ ì§œì™€ ê°™ë‹¤ë©´ ìƒ‰ìƒì„ íŒŒë—ê²Œ ê°•ì¡°!
    if (i === todayDate) {
        th.style.color = "#007aff"; 
        th.style.fontWeight = "bold";
        th.style.textDecoration = "underline";
    }
    
    dateHeader.appendChild(th);
}

        trackerBody.innerHTML = '';
        const monthData = allMonthsData[currentMonth] || { items: [] };

        monthData.items.forEach((item, rIndex) => {
            const tr = document.createElement('tr');
            const nameTd = document.createElement('td');
            nameTd.className = 'checklist-item';
            
            const delBtn = document.createElement('button');
            delBtn.innerHTML = 'âŠ–'; delBtn.style = "color:#ff3b30; border:none; background:none; font-size:18px; padding:0 0 0 5px; flex-shrink:0;";
            delBtn.onclick = () => { if(confirm('ì‚­ì œí• ê¹Œìš”?')) { monthData.items.splice(rIndex, 1); saveToDB(); } };
            
            const input = document.createElement('input');
            input.value = item.name;
            input.onchange = (e) => { item.name = e.target.value; saveToDB(); };

           // wrapperë¼ëŠ” ë°”êµ¬ë‹ˆì— ë‹´ì•„ì„œ tdì— ë„£ìŠµë‹ˆë‹¤.
            const wrapper = document.createElement('div');
            wrapper.className = 'item-wrapper';

            wrapper.appendChild(input);
            wrapper.appendChild(delBtn);

            nameTd.appendChild(wrapper);
            tr.appendChild(nameTd);

            for (let d = 0; d < DAYS; d++) {
                const td = document.createElement('td');
                td.className = 'status-cell';
                const circle = document.createElement('div');
                circle.className = `circle ${item.history[d]}`;
                circle.onclick = () => {
                    const states = ['none', 'good', 'normal', 'bad'];
                    item.history[d] = states[(states.indexOf(item.history[d]) + 1) % 4];
                    circle.className = `circle ${item.history[d]}`;
                    saveToDB();
                };
                td.appendChild(circle);
                tr.appendChild(td);
            }
            trackerBody.appendChild(tr);
        });
    }

    function addRow() {
        if (!allMonthsData[currentMonth]) allMonthsData[currentMonth] = { items: [] };
        allMonthsData[currentMonth].items.push({ name: "ìƒˆ í•­ëª©", history: Array(31).fill('none') });
        saveToDB();
    }

    function init() {
        const select = document.getElementById('monthSelect');
        for (let i = 1; i <= 12; i++) {
            const opt = document.createElement('option');
            opt.value = String(i); opt.innerText = i + 'ì›”';
            if (i === parseInt(currentMonth)) opt.selected = true;
            select.appendChild(opt);
        }
        syncData();
    }

    init();
</script>
</body>
</html>